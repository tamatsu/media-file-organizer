<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Media File Organizer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .main-content {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      .file-list-container {
        flex: 1;
        min-width: 400px;
      }
      .preview-container {
        flex: 1;
        min-width: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        background-color: #fafafa;
        position: sticky;
        top: 20px;
        height: fit-content;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      .controls {
        margin-bottom: 20px;
        text-align: center;
      }
      button {
        background-color: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #005a9e;
      }
      .file-list {
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 300px;
        padding: 10px;
      }
      .folder-info {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border-left: 4px solid #007acc;
      }
      .file-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #fafafa;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .file-item:hover {
        background-color: #e6f3ff;
      }
      .file-item.selected {
        background-color: #cce7ff;
        border-color: #007acc;
      }
      .file-icon {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        text-align: center;
      }
      .file-details {
        flex: 1;
      }
      .file-name {
        font-weight: bold;
        color: #333;
      }
      .file-meta {
        font-size: 0.8em;
        color: #666;
        margin-top: 2px;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
      .preview-content {
        text-align: center;
      }
      .preview-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .preview-video {
        width: 100%;
        max-height: 400px;
        border-radius: 4px;
      }
      .preview-audio {
        width: 100%;
        margin-top: 20px;
      }
      .preview-info {
        margin-top: 15px;
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        text-align: left;
      }
      .preview-placeholder {
        padding: 40px;
        text-align: center;
        color: #999;
        font-style: italic;
      }
      .search-filters {
        margin-bottom: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }
      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .filter-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }
      .filter-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .filter-btn:hover {
        background-color: #e6f3ff;
      }
      .filter-btn.active {
        background-color: #007acc;
        color: white;
        border-color: #007acc;
      }
      .file-count {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .sort-rating-controls {
        margin-top: 10px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
      }
      .sort-controls,
      .rating-filter-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .sort-controls label,
      .rating-filter-controls label {
        font-size: 12px;
        font-weight: bold;
        color: #333;
        white-space: nowrap;
      }
      .sort-select,
      .rating-filter {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background-color: white;
        cursor: pointer;
        min-width: 140px;
      }
      .sort-select:focus,
      .rating-filter:focus {
        outline: none;
        border-color: #007acc;
        box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
      }
      .album-group {
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
      }
      .album-header {
        background-color: #f8f9fa;
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }
      .album-header:hover {
        background-color: #e9ecef;
      }
      .album-title {
        font-weight: bold;
        color: #333;
      }
      .album-meta {
        font-size: 12px;
        color: #666;
      }
      .album-rating {
        margin-top: 4px;
      }
      .star {
        color: #ddd;
        font-size: 16px;
        cursor: pointer;
        margin-right: 2px;
        transition: color 0.2s;
      }
      .star:hover {
        color: #ffa500;
      }
      .star.active {
        color: #ffd700;
      }
      .album-toggle {
        font-size: 14px;
        color: #666;
      }
      .album-files {
        padding: 10px;
      }
      .album-files.collapsed {
        display: none;
      }
      .artist-group {
        margin-bottom: 25px;
        border: 2px solid #d0d7de;
        border-radius: 8px;
        overflow: hidden;
      }
      .artist-header {
        background-color: #f6f8fa;
        padding: 15px 18px;
        border-bottom: 2px solid #d0d7de;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }
      .artist-header:hover {
        background-color: #eef2f5;
      }
      .artist-title {
        font-weight: bold;
        font-size: 16px;
        color: #1f2328;
      }
      .artist-meta {
        font-size: 13px;
        color: #656d76;
      }
      .artist-albums {
        padding: 15px;
        background-color: #ffffff;
      }
      .artist-albums.collapsed {
        display: none;
      }
      .nested-album {
        margin-bottom: 15px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        overflow: hidden;
      }
      .nested-album:last-child {
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Media File Organizer</h1>
      <div class="controls">
        <button onclick="selectFolder()">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
        <button onclick="refreshFiles()">æ›´æ–°</button>
      </div>
      <div class="main-content">
        <div class="file-list-container">
          <h3>ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h3>
          <div class="search-filters" id="searchFilters" style="display: none">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¢ãƒ«ãƒãƒ ã§æ¤œç´¢..."
            />
            <div class="filter-buttons">
              <button class="filter-btn active" data-type="all">å…¨ã¦</button>
              <button class="filter-btn" data-type="image">ğŸ–¼ï¸ ç”»åƒ</button>
              <button class="filter-btn" data-type="video">ğŸ¬ å‹•ç”»</button>
              <button class="filter-btn" data-type="audio">ğŸµ éŸ³å£°</button>
              <button class="filter-btn" id="artistGroupBtn" data-group="artist">
                ğŸ¤ ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ¥
              </button>
            </div>
            <div class="sort-rating-controls">
              <div class="sort-controls">
                <label for="sortSelect">ä¸¦ã³é †:</label>
                <select id="sortSelect" class="sort-select">
                  <option value="name-asc">ã‚¢ãƒ«ãƒãƒ å (A-Z)</option>
                  <option value="name-desc">ã‚¢ãƒ«ãƒãƒ å (Z-A)</option>
                  <option value="artist-asc">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå (A-Z)</option>
                  <option value="artist-desc">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå (Z-A)</option>
                  <option value="rating-desc">ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (é«˜â†’ä½)</option>
                  <option value="rating-asc">ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (ä½â†’é«˜)</option>
                  <option value="filecount-desc">ãƒ•ã‚¡ã‚¤ãƒ«æ•° (å¤šâ†’å°‘)</option>
                  <option value="filecount-asc">ãƒ•ã‚¡ã‚¤ãƒ«æ•° (å°‘â†’å¤š)</option>
                </select>
              </div>
              <div class="rating-filter-controls">
                <label for="ratingFilter">ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                <select id="ratingFilter" class="rating-filter">
                  <option value="all">å…¨ã¦è¡¨ç¤º</option>
                  <option value="5">â˜…â˜…â˜…â˜…â˜… (5æ˜Ÿ)</option>
                  <option value="4">â˜…â˜…â˜…â˜…â˜† (4æ˜Ÿä»¥ä¸Š)</option>
                  <option value="3">â˜…â˜…â˜…â˜†â˜† (3æ˜Ÿä»¥ä¸Š)</option>
                  <option value="2">â˜…â˜…â˜†â˜†â˜† (2æ˜Ÿä»¥ä¸Š)</option>
                  <option value="1">â˜…â˜†â˜†â˜†â˜† (1æ˜Ÿä»¥ä¸Š)</option>
                  <option value="unrated">æœªè©•ä¾¡ã®ã¿</option>
                </select>
              </div>
            </div>
            <div class="file-count" id="fileCount"></div>
          </div>
          <div class="file-list" id="fileList">
            <p>ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™</p>
          </div>
        </div>
        <div class="preview-container">
          <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div class="preview-content" id="previewContent">
            <div class="preview-placeholder">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require('electron');

      // Load utility modules
      const ratingUtils = require('./renderer/utils/rating');
      const sortingUtils = require('./renderer/utils/sorting');
      const searchUtils = require('./renderer/utils/search');

      // Make rating functions available globally for backward compatibility
      window.ratingUtils = ratingUtils;
      const { saveRating, loadRating, loadAllRatings, getAlbumRating } = ratingUtils;
      const { filterAlbumsByRating, sortAlbums } = sortingUtils;
      const { filterFilesBySearch, filterFilesByType, groupFilesByArtist, groupFilesByAlbum } =
        searchUtils;

      let currentFolder = null;
      let allFiles = [];
      let currentFilter = 'all';
      let currentSearch = '';
      let groupByArtist = false;
      let groupByAlbum = false;
      let currentSort = 'name-asc';
      let currentRatingFilter = 'all';

      async function selectFolder() {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.appendChild(document.createTextNode('ãƒ•ã‚©ãƒ«ãƒ€ã‚’èª­ã¿è¾¼ã¿ä¸­...'));
        loadingDiv.appendChild(document.createElement('br'));
        const smallText = document.createElement('small');
        smallText.textContent = 'ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚‚å«ã‚ã¦æ¤œç´¢ã—ã¦ã„ã¾ã™';
        loadingDiv.appendChild(smallText);
        fileList.appendChild(loadingDiv);

        try {
          const result = await ipcRenderer.invoke('select-folder');
          if (result) {
            currentFolder = result;
            allFiles = result.files;
            setupFilters();
            displayFilteredFiles();
          } else {
            fileList.innerHTML = '';
            const message = document.createElement('p');
            message.textContent = 'ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
            fileList.appendChild(message);
          }
        } catch (error) {
          console.error('=== FOLDER SELECTION ERROR ===');
          console.error('Error message:', error.message);
          console.error('Error stack:', error.stack);
          console.error('Error type:', error.constructor.name);
          console.error('Application state:', {
            groupByArtist: groupByArtist,
            currentFilter: currentFilter,
            allFilesCount: allFiles?.length || 0,
            currentFolderPath: currentFolder?.folder || 'none'
          });
          console.error('================================');

          fileList.innerHTML = '';
          const message = document.createElement('p');
          message.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || 'Unknown error'}`;
          fileList.appendChild(message);
        }
      }

      function displayFiles(data) {
        const fileList = document.getElementById('fileList');

        // Clear existing content
        fileList.innerHTML = '';

        if (!data || !data.files || data.files.length === 0) {
          const message = document.createElement('p');
          message.textContent = 'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
          fileList.appendChild(message);
          return;
        }

        // Create folder info section
        const folderInfo = document.createElement('div');
        folderInfo.className = 'folder-info';

        const folderPath = document.createElement('div');
        const folderLabel = document.createElement('strong');
        folderLabel.textContent = 'é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€:';
        folderPath.appendChild(folderLabel);
        folderPath.appendChild(document.createTextNode(' ' + data.folder));

        const fileCount = document.createElement('div');
        const countLabel = document.createElement('strong');
        countLabel.textContent = 'ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«æ•°:';
        fileCount.appendChild(countLabel);
        fileCount.appendChild(document.createTextNode(` ${data.files.length}ä»¶`));

        folderInfo.appendChild(folderPath);
        folderInfo.appendChild(fileCount);
        fileList.appendChild(folderInfo);

        // Create file items
        data.files.forEach(file => {
          const icon = getFileIcon(file.type);
          const sizeStr = formatFileSize(file.size);
          const dateStr = new Date(file.modified).toLocaleDateString('ja-JP');

          // Create file item container
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.dataset.path = file.path;

          // Add click event listener
          fileItem.addEventListener('click', () => {
            previewFile(file.path, file.type, file.name, file.size);
          });

          // Create icon element
          const iconDiv = document.createElement('div');
          iconDiv.className = 'file-icon';
          iconDiv.textContent = icon;

          // Create details container
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'file-details';

          // Create file name element
          const fileName = document.createElement('div');
          fileName.className = 'file-name';
          fileName.textContent = file.name;

          // Create file meta element
          const fileMeta = document.createElement('div');
          fileMeta.className = 'file-meta';

          // Add folder path if file is in subdirectory
          const pathInfo = file.relativePath ? ` (${file.relativePath}/)` : '';
          fileMeta.textContent = `${file.type} â€¢ ${sizeStr} â€¢ ${dateStr}${pathInfo}`;

          // Assemble the structure
          detailsDiv.appendChild(fileName);
          detailsDiv.appendChild(fileMeta);
          fileItem.appendChild(iconDiv);
          fileItem.appendChild(detailsDiv);
          fileList.appendChild(fileItem);
        });
      }

      function getFileIcon(type) {
        switch (type) {
          case 'image':
            return 'ğŸ–¼ï¸';
          case 'video':
            return 'ğŸ¬';
          case 'audio':
            return 'ğŸµ';
          default:
            return 'ğŸ“„';
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      function refreshFiles() {
        if (currentFolder) {
          displayFilteredFiles();
        } else {
          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';
          const message = document.createElement('p');
          message.textContent = 'ã¾ãšãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„';
          fileList.appendChild(message);
        }
      }

      function setupFilters() {
        const searchFilters = document.getElementById('searchFilters');
        const searchInput = document.getElementById('searchInput');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const sortSelect = document.getElementById('sortSelect');
        const ratingFilter = document.getElementById('ratingFilter');

        // Show filters
        searchFilters.style.display = 'block';

        // Setup search input
        searchInput.addEventListener('input', e => {
          currentSearch = e.target.value.toLowerCase();
          displayFilteredFiles();
        });

        // Setup sort select
        sortSelect.addEventListener('change', e => {
          currentSort = e.target.value;
          displayFilteredFiles();
        });

        // Setup rating filter
        ratingFilter.addEventListener('change', e => {
          currentRatingFilter = e.target.value;
          displayFilteredFiles();
        });

        // Setup filter buttons
        filterButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.dataset.group === 'artist') {
              // Toggle artist grouping
              groupByArtist = !groupByArtist;
              btn.classList.toggle('active');

              // Reset filters when grouping by artist
              if (groupByArtist) {
                filterButtons.forEach(b => {
                  if (b.dataset.type) b.classList.remove('active');
                });
                document.querySelector('[data-type="all"]').classList.add('active');
                currentFilter = 'all';
              }
            } else {
              // Regular filter buttons
              if (groupByArtist) {
                groupByArtist = false;
                document.getElementById('artistGroupBtn').classList.remove('active');
              }
              filterButtons.forEach(b => {
                if (b.dataset.type) b.classList.remove('active');
              });
              btn.classList.add('active');
              currentFilter = btn.dataset.type;
            }
            displayFilteredFiles();
          });
        });
      }

      function displayFilteredFiles() {
        if (!allFiles || allFiles.length === 0) {
          displayFiles({ folder: currentFolder?.folder || '', files: [] });
          return;
        }

        // Apply filters
        let filteredFiles = filterFilesByType(allFiles, currentFilter);
        filteredFiles = filterFilesBySearch(filteredFiles, currentSearch);

        // Update file count
        const fileCount = document.getElementById('fileCount');
        fileCount.textContent = `${filteredFiles.length}ä»¶ / ${allFiles.length}ä»¶`;

        // Display files (grouped or normal)
        if (groupByArtist) {
          displayArtistGroups(filteredFiles);
        } else {
          displayFiles({
            folder: currentFolder.folder,
            files: filteredFiles
          });
        }
      }

      function displayAlbumGroups(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        // Group files by album
        const albumGroups = {};
        files.forEach(file => {
          const album = file.album || 'ã‚¢ãƒ«ãƒãƒ åãªã—';
          if (!albumGroups[album]) {
            albumGroups[album] = [];
          }
          albumGroups[album].push(file);
        });

        // Create album groups
        Object.keys(albumGroups)
          .sort()
          .forEach(albumName => {
            const albumFiles = albumGroups[albumName];
            const albumGroup = document.createElement('div');
            albumGroup.className = 'album-group';

            // Create album header
            const albumHeader = document.createElement('div');
            albumHeader.className = 'album-header';
            albumHeader.addEventListener('click', () => {
              const albumFilesDiv = albumGroup.querySelector('.album-files');
              const toggle = albumGroup.querySelector('.album-toggle');
              albumFilesDiv.classList.toggle('collapsed');
              toggle.textContent = albumFilesDiv.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
            });

            const albumInfo = document.createElement('div');
            const albumTitle = document.createElement('div');
            albumTitle.className = 'album-title';
            albumTitle.textContent = albumName;

            const albumMeta = document.createElement('div');
            albumMeta.className = 'album-meta';
            const audioCount = albumFiles.filter(f => f.type === 'audio').length;
            const imageCount = albumFiles.filter(f => f.type === 'image').length;
            const videoCount = albumFiles.filter(f => f.type === 'video').length;
            let metaText = `${albumFiles.length}ä»¶`;
            if (audioCount > 0) metaText += ` (ğŸµ${audioCount}`;
            if (imageCount > 0) metaText += ` ğŸ–¼ï¸${imageCount}`;
            if (videoCount > 0) metaText += ` ğŸ¬${videoCount}`;
            if (audioCount > 0 || imageCount > 0 || videoCount > 0) metaText += ')';
            albumMeta.textContent = metaText;

            albumInfo.appendChild(albumTitle);
            albumInfo.appendChild(albumMeta);

            // Add star rating UI
            const albumRating = document.createElement('div');
            albumRating.className = 'album-rating';

            // Get artist name from the first file in the album for rating key
            const firstFile = albumFiles[0];
            const artistName = firstFile.artist || 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãªã—';
            const albumKey = `${artistName}/${albumName}`;

            for (let i = 1; i <= 5; i++) {
              const star = document.createElement('span');
              star.className = 'star';
              star.textContent = 'â˜…';
              star.dataset.rating = i;
              star.dataset.albumKey = albumKey;

              // Add click handler for star rating
              star.addEventListener('click', async e => {
                e.stopPropagation();
                const rating = parseInt(e.target.dataset.rating);
                const albumKey = e.target.dataset.albumKey;

                // Update visual state
                const stars = albumRating.querySelectorAll('.star');
                stars.forEach((s, index) => {
                  if (index < rating) {
                    s.classList.add('active');
                  } else {
                    s.classList.remove('active');
                  }
                });

                // Save rating
                saveRating(albumKey, rating);
                console.log(`Rating saved: ${albumKey} = ${rating} stars`);
              });

              albumRating.appendChild(star);
            }

            albumInfo.appendChild(albumRating);

            // Load and display saved rating
            const savedRating = loadRating(albumKey);
            console.log(`Loading rating for album: ${albumKey} = ${savedRating} stars`);
            if (savedRating > 0) {
              const stars = albumRating.querySelectorAll('.star');
              stars.forEach((s, index) => {
                if (index < savedRating) {
                  s.classList.add('active');
                }
              });
            }

            const albumToggle = document.createElement('div');
            albumToggle.className = 'album-toggle';
            albumToggle.textContent = 'â–¼';

            albumHeader.appendChild(albumInfo);
            albumHeader.appendChild(albumToggle);

            // Create album files container
            const albumFilesDiv = document.createElement('div');
            albumFilesDiv.className = 'album-files';

            // Add files to album
            albumFiles.forEach(file => {
              const fileItem = createFileItem(file);
              albumFilesDiv.appendChild(fileItem);
            });

            albumGroup.appendChild(albumHeader);
            albumGroup.appendChild(albumFilesDiv);
            fileList.appendChild(albumGroup);
          });
      }

      function displayArtistGroups(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        // Group files by artist, then by album
        let artistGroups = groupFilesByArtist(files);

        // Apply rating filter
        artistGroups = filterAlbumsByRating(artistGroups, currentRatingFilter);

        // Apply sorting
        artistGroups = sortAlbums(artistGroups, currentSort);

        // Create artist groups
        Object.keys(artistGroups).forEach(artistName => {
          const artistAlbums = artistGroups[artistName];
          const artistGroup = document.createElement('div');
          artistGroup.className = 'artist-group';

          // Create artist header
          const artistHeader = document.createElement('div');
          artistHeader.className = 'artist-header';
          artistHeader.addEventListener('click', () => {
            const artistAlbumsDiv = artistGroup.querySelector('.artist-albums');
            const toggle = artistGroup.querySelector('.album-toggle');
            artistAlbumsDiv.classList.toggle('collapsed');
            toggle.textContent = artistAlbumsDiv.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
          });

          const artistInfo = document.createElement('div');
          const artistTitle = document.createElement('div');
          artistTitle.className = 'artist-title';
          artistTitle.textContent = `ğŸ“€ ${artistName}`;

          const artistMeta = document.createElement('div');
          artistMeta.className = 'artist-meta';
          const albumCount = Object.keys(artistAlbums).length;
          const totalFiles = Object.values(artistAlbums).flat().length;
          const audioCount = Object.values(artistAlbums)
            .flat()
            .filter(f => f.type === 'audio').length;
          const imageCount = Object.values(artistAlbums)
            .flat()
            .filter(f => f.type === 'image').length;
          const videoCount = Object.values(artistAlbums)
            .flat()
            .filter(f => f.type === 'video').length;

          let metaText = `${albumCount}ã‚¢ãƒ«ãƒãƒ , ${totalFiles}ä»¶`;
          if (audioCount > 0) metaText += ` (ğŸµ${audioCount}`;
          if (imageCount > 0) metaText += ` ğŸ–¼ï¸${imageCount}`;
          if (videoCount > 0) metaText += ` ğŸ¬${videoCount}`;
          if (audioCount > 0 || imageCount > 0 || videoCount > 0) metaText += ')';
          artistMeta.textContent = metaText;

          artistInfo.appendChild(artistTitle);
          artistInfo.appendChild(artistMeta);

          const artistToggle = document.createElement('div');
          artistToggle.className = 'album-toggle';
          artistToggle.textContent = 'â–¼';

          artistHeader.appendChild(artistInfo);
          artistHeader.appendChild(artistToggle);

          // Create artist albums container
          const artistAlbumsDiv = document.createElement('div');
          artistAlbumsDiv.className = 'artist-albums';

          // Add albums to artist
          Object.keys(artistAlbums)
            .sort()
            .forEach(albumName => {
              const albumFiles = artistAlbums[albumName];
              const nestedAlbum = document.createElement('div');
              nestedAlbum.className = 'nested-album';

              // Create album header
              const albumHeader = document.createElement('div');
              albumHeader.className = 'album-header';
              albumHeader.addEventListener('click', () => {
                const albumFilesDiv = nestedAlbum.querySelector('.album-files');
                const toggle = nestedAlbum.querySelector('.album-toggle');
                albumFilesDiv.classList.toggle('collapsed');
                toggle.textContent = albumFilesDiv.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
              });

              const albumInfo = document.createElement('div');
              const albumTitle = document.createElement('div');
              albumTitle.className = 'album-title';
              albumTitle.textContent = `ğŸ“ ${albumName}`;

              const albumMeta = document.createElement('div');
              albumMeta.className = 'album-meta';
              const albumAudioCount = albumFiles.filter(f => f.type === 'audio').length;
              const albumImageCount = albumFiles.filter(f => f.type === 'image').length;
              const albumVideoCount = albumFiles.filter(f => f.type === 'video').length;
              let albumMetaText = `${albumFiles.length}ä»¶`;
              if (albumAudioCount > 0) albumMetaText += ` (ğŸµ${albumAudioCount}`;
              if (albumImageCount > 0) albumMetaText += ` ğŸ–¼ï¸${albumImageCount}`;
              if (albumVideoCount > 0) albumMetaText += ` ğŸ¬${albumVideoCount}`;
              if (albumAudioCount > 0 || albumImageCount > 0 || albumVideoCount > 0)
                albumMetaText += ')';
              albumMeta.textContent = albumMetaText;

              albumInfo.appendChild(albumTitle);
              albumInfo.appendChild(albumMeta);

              // Add star rating UI
              const albumRating = document.createElement('div');
              albumRating.className = 'album-rating';

              for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = 'star';
                star.textContent = 'â˜…';
                star.dataset.rating = i;
                star.dataset.albumKey = `${artistName}/${albumName}`;

                // Add click handler for star rating
                star.addEventListener('click', async e => {
                  e.stopPropagation();
                  const rating = parseInt(e.target.dataset.rating);
                  const albumKey = e.target.dataset.albumKey;

                  // Update visual state
                  const stars = albumRating.querySelectorAll('.star');
                  stars.forEach((s, index) => {
                    if (index < rating) {
                      s.classList.add('active');
                    } else {
                      s.classList.remove('active');
                    }
                  });

                  // Save rating
                  saveRating(albumKey, rating);
                  console.log(`Rating saved: ${albumKey} = ${rating} stars`);
                });

                albumRating.appendChild(star);
              }

              albumInfo.appendChild(albumRating);

              // Load and display saved rating
              const albumKey = `${artistName}/${albumName}`;
              const savedRating = loadRating(albumKey);
              console.log(`Loading rating for album: ${albumKey} = ${savedRating} stars`);
              if (savedRating > 0) {
                const stars = albumRating.querySelectorAll('.star');
                stars.forEach((s, index) => {
                  if (index < savedRating) {
                    s.classList.add('active');
                  }
                });
              }

              const albumToggle = document.createElement('div');
              albumToggle.className = 'album-toggle';
              albumToggle.textContent = 'â–¶';

              albumHeader.appendChild(albumInfo);
              albumHeader.appendChild(albumToggle);

              // Create album files container (collapsed by default)
              const albumFilesDiv = document.createElement('div');
              albumFilesDiv.className = 'album-files collapsed';

              // Add files to album
              albumFiles.forEach(file => {
                const fileItem = createFileItem(file);
                albumFilesDiv.appendChild(fileItem);
              });

              nestedAlbum.appendChild(albumHeader);
              nestedAlbum.appendChild(albumFilesDiv);
              artistAlbumsDiv.appendChild(nestedAlbum);
            });

          artistGroup.appendChild(artistHeader);
          artistGroup.appendChild(artistAlbumsDiv);
          fileList.appendChild(artistGroup);
        });
      }

      function createFileItem(file) {
        const icon = getFileIcon(file.type);
        const sizeStr = formatFileSize(file.size);
        const dateStr = new Date(file.modified).toLocaleDateString('ja-JP');

        // Create file item container
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.path = file.path;

        // Add click event listener
        fileItem.addEventListener('click', () => {
          previewFile(file.path, file.type, file.name, file.size);
        });

        // Create icon element
        const iconDiv = document.createElement('div');
        iconDiv.className = 'file-icon';
        iconDiv.textContent = icon;

        // Create details container
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'file-details';

        // Create file name element (show title if available)
        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.textContent = file.title || file.name;

        // Create file meta element
        const fileMeta = document.createElement('div');
        fileMeta.className = 'file-meta';

        // Add artist info for audio files
        let metaText = `${file.type} â€¢ ${sizeStr} â€¢ ${dateStr}`;
        if (file.artist && file.type === 'audio') {
          metaText = `${file.artist} â€¢ ${metaText}`;
        }
        if (file.relativePath) {
          metaText += ` (${file.relativePath}/)`;
        }
        fileMeta.textContent = metaText;

        // Assemble the structure
        detailsDiv.appendChild(fileName);
        detailsDiv.appendChild(fileMeta);
        fileItem.appendChild(iconDiv);
        fileItem.appendChild(detailsDiv);

        return fileItem;
      }

      async function previewFile(filePath, fileType, fileName, fileSize) {
        // Remove previous selection
        document.querySelectorAll('.file-item').forEach(item => {
          item.classList.remove('selected');
        });

        // Add selection to clicked item
        event.target.closest('.file-item').classList.add('selected');

        const previewContent = document.getElementById('previewContent');
        const sizeStr = formatFileSize(fileSize);

        // Show loading state
        previewContent.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        const loadingText = document.createElement('p');
        loadingText.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
        loadingDiv.appendChild(loadingText);
        previewContent.appendChild(loadingDiv);

        try {
          const dataUrl = await ipcRenderer.invoke('get-file-url', filePath);

          if (!dataUrl) {
            throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          // Create preview content container
          previewContent.innerHTML = '';
          const previewDiv = document.createElement('div');
          previewDiv.className = 'preview-content';

          // Create media element
          let mediaEl;
          switch (fileType) {
            case 'image':
              mediaEl = document.createElement('img');
              mediaEl.src = dataUrl;
              mediaEl.className = 'preview-image';
              mediaEl.alt = fileName;
              mediaEl.style.opacity = '0';
              mediaEl.style.transition = 'opacity 0.3s';
              mediaEl.onload = () => (mediaEl.style.opacity = '1');
              break;
            case 'video':
              mediaEl = document.createElement('video');
              mediaEl.className = 'preview-video';
              mediaEl.controls = true;
              mediaEl.preload = 'metadata';
              const videoSource = document.createElement('source');
              videoSource.src = dataUrl;
              mediaEl.appendChild(videoSource);
              const videoFallback = document.createElement('p');
              videoFallback.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã®å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚';
              mediaEl.appendChild(videoFallback);
              break;
            case 'audio':
              const audioContainer = document.createElement('div');
              audioContainer.style.textAlign = 'center';
              audioContainer.style.margin = '40px 0';
              const audioIcon = document.createElement('div');
              audioIcon.style.fontSize = '48px';
              audioIcon.style.marginBottom = '20px';
              audioIcon.textContent = 'ğŸµ';
              const audioEl = document.createElement('audio');
              audioEl.className = 'preview-audio';
              audioEl.controls = true;
              audioEl.preload = 'metadata';
              const audioSource = document.createElement('source');
              audioSource.src = dataUrl;
              audioEl.appendChild(audioSource);
              const audioFallback = document.createElement('p');
              audioFallback.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°ã®å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚';
              audioEl.appendChild(audioFallback);
              audioContainer.appendChild(audioIcon);
              audioContainer.appendChild(audioEl);
              mediaEl = audioContainer;
              break;
            default:
              const placeholder = document.createElement('div');
              placeholder.className = 'preview-placeholder';
              const placeholderIcon = document.createElement('div');
              placeholderIcon.style.fontSize = '48px';
              placeholderIcon.style.marginBottom = '20px';
              placeholderIcon.textContent = 'ğŸ“„';
              const placeholderText = document.createElement('p');
              placeholderText.textContent = 'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã›ã‚“';
              placeholder.appendChild(placeholderIcon);
              placeholder.appendChild(placeholderText);
              mediaEl = placeholder;
          }

          // Create info section
          const infoDiv = document.createElement('div');
          infoDiv.className = 'preview-info';

          const fileNameInfo = document.createElement('div');
          const fileNameLabel = document.createElement('strong');
          fileNameLabel.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«å:';
          fileNameInfo.appendChild(fileNameLabel);
          fileNameInfo.appendChild(document.createTextNode(' ' + fileName));

          const fileSizeInfo = document.createElement('div');
          const fileSizeLabel = document.createElement('strong');
          fileSizeLabel.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:';
          fileSizeInfo.appendChild(fileSizeLabel);
          fileSizeInfo.appendChild(document.createTextNode(' ' + sizeStr));

          const fileTypeInfo = document.createElement('div');
          const fileTypeLabel = document.createElement('strong');
          fileTypeLabel.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼:';
          fileTypeInfo.appendChild(fileTypeLabel);
          fileTypeInfo.appendChild(document.createTextNode(' ' + fileType));

          const filePathInfo = document.createElement('div');
          const filePathLabel = document.createElement('strong');
          filePathLabel.textContent = 'ãƒ‘ã‚¹:';
          filePathInfo.appendChild(filePathLabel);
          filePathInfo.appendChild(document.createTextNode(' ' + filePath));

          infoDiv.appendChild(fileNameInfo);
          infoDiv.appendChild(fileSizeInfo);
          infoDiv.appendChild(fileTypeInfo);
          infoDiv.appendChild(filePathInfo);

          previewDiv.appendChild(mediaEl);
          previewDiv.appendChild(infoDiv);
          previewContent.appendChild(previewDiv);
        } catch (error) {
          console.error('=== FILE PREVIEW ERROR ===');
          console.error('Error message:', error.message);
          console.error('Error stack:', error.stack);
          console.error('File details:', {
            fileName: fileName,
            filePath: filePath,
            fileType: fileType,
            fileSize: fileSize
          });
          console.error('==========================');
          previewContent.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'preview-placeholder';

          const errorIcon = document.createElement('div');
          errorIcon.style.fontSize = '48px';
          errorIcon.style.marginBottom = '20px';
          errorIcon.textContent = 'âŒ';

          const errorText = document.createElement('p');
          errorText.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';

          const errorDetails = document.createElement('p');
          errorDetails.style.fontSize = '0.8em';
          errorDetails.style.color = '#666';
          errorDetails.textContent = error.message;

          errorDiv.appendChild(errorIcon);
          errorDiv.appendChild(errorText);
          errorDiv.appendChild(errorDetails);
          previewContent.appendChild(errorDiv);
        }
      }

      // Global error handlers for better debugging
      window.addEventListener('error', event => {
        console.error('=== GLOBAL JAVASCRIPT ERROR ===');
        console.error('Error message:', event.message);
        console.error('Source file:', event.filename);
        console.error('Line number:', event.lineno);
        console.error('Column number:', event.colno);
        console.error('Error object:', event.error);
        console.error('==============================');
      });

      window.addEventListener('unhandledrejection', event => {
        console.error('=== UNHANDLED PROMISE REJECTION ===');
        console.error('Reason:', event.reason);
        console.error('Promise:', event.promise);
        console.error('Stack:', event.reason?.stack);
        console.error('===================================');
      });
    </script>
  </body>
</html>
