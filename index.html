<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Media File Organizer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .main-content {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      .file-list-container {
        flex: 1;
        min-width: 400px;
      }
      .preview-container {
        flex: 1;
        min-width: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        background-color: #fafafa;
        position: sticky;
        top: 20px;
        height: fit-content;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      .controls {
        margin-bottom: 20px;
        text-align: center;
      }
      button {
        background-color: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #005a9e;
      }
      .file-list {
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 300px;
        padding: 10px;
      }
      .folder-info {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border-left: 4px solid #007acc;
      }
      .file-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #fafafa;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .file-item:hover {
        background-color: #e6f3ff;
      }
      .file-item.selected {
        background-color: #cce7ff;
        border-color: #007acc;
      }
      .file-icon {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        text-align: center;
      }
      .file-details {
        flex: 1;
      }
      .file-name {
        font-weight: bold;
        color: #333;
      }
      .file-meta {
        font-size: 0.8em;
        color: #666;
        margin-top: 2px;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
      .preview-content {
        text-align: center;
      }
      .preview-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .preview-video {
        width: 100%;
        max-height: 400px;
        border-radius: 4px;
      }
      .preview-audio {
        width: 100%;
        margin-top: 20px;
      }
      .preview-info {
        margin-top: 15px;
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        text-align: left;
      }
      .preview-placeholder {
        padding: 40px;
        text-align: center;
        color: #999;
        font-style: italic;
      }
      .search-filters {
        margin-bottom: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }
      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .filter-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }
      .filter-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .filter-btn:hover {
        background-color: #e6f3ff;
      }
      .filter-btn.active {
        background-color: #007acc;
        color: white;
        border-color: #007acc;
      }
      .file-count {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .sort-rating-controls {
        margin-top: 10px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
      }
      .sort-controls,
      .rating-filter-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .sort-controls label,
      .rating-filter-controls label {
        font-size: 12px;
        font-weight: bold;
        color: #333;
        white-space: nowrap;
      }
      .sort-select,
      .rating-filter {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background-color: white;
        cursor: pointer;
        min-width: 140px;
      }
      .sort-select:focus,
      .rating-filter:focus {
        outline: none;
        border-color: #007acc;
        box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
      }
      .album-group {
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
      }
      .album-header {
        background-color: #f8f9fa;
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }
      .album-header:hover {
        background-color: #e9ecef;
      }
      .album-thumbnail-container {
        width: 48px;
        height: 48px;
        margin-right: 12px;
        flex-shrink: 0;
        border-radius: 6px;
        overflow: hidden;
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .album-thumbnail-container.loading {
        background-color: #e9ecef;
        position: relative;
      }
      .album-thumbnail-container.loading::after {
        content: '‚è≥';
        font-size: 16px;
      }
      .album-thumbnail-container.placeholder {
        background-color: #f1f3f4;
      }
      .album-thumbnail-container.error {
        background-color: #ffeaa7;
      }
      .album-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .album-thumbnail-placeholder {
        font-size: 20px;
        color: #666;
      }
      .album-thumbnail-error {
        font-size: 16px;
        color: #d63031;
      }
      .album-title {
        font-weight: bold;
        color: #333;
      }
      .album-meta {
        font-size: 12px;
        color: #666;
      }
      .album-rating {
        margin-top: 4px;
      }
      .star {
        color: #ddd;
        font-size: 16px;
        cursor: pointer;
        margin-right: 2px;
        transition: color 0.2s;
      }
      .star:hover {
        color: #ffa500;
      }
      .star.active {
        color: #ffd700;
      }
      .album-toggle {
        font-size: 14px;
        color: #666;
      }
      .album-files {
        padding: 10px;
      }
      .album-files.collapsed {
        display: none;
      }
      .artist-group {
        margin-bottom: 25px;
        border: 2px solid #d0d7de;
        border-radius: 8px;
        overflow: hidden;
      }
      .artist-header {
        background-color: #f6f8fa;
        padding: 15px 18px;
        border-bottom: 2px solid #d0d7de;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }
      .artist-header:hover {
        background-color: #eef2f5;
      }
      .artist-title {
        font-weight: bold;
        font-size: 16px;
        color: #1f2328;
      }
      .artist-meta {
        font-size: 13px;
        color: #656d76;
      }
      .artist-albums {
        padding: 15px;
        background-color: #ffffff;
      }
      .artist-albums.collapsed {
        display: none;
      }
      .nested-album {
        margin-bottom: 15px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        overflow: hidden;
      }
      .nested-album:last-child {
        margin-bottom: 0;
      }
      /* Grid View Styles */
      .album-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }
      .album-grid-item {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .album-grid-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border-color: #007acc;
      }
      .album-card {
        text-align: center;
      }
      .album-card .album-thumbnail-container {
        width: 120px;
        height: 120px;
        margin: 0 auto 12px auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .album-card .album-thumbnail-container.loading::after {
        font-size: 24px;
      }
      .album-card .album-thumbnail-placeholder {
        font-size: 32px;
      }
      .album-card .album-thumbnail-error {
        font-size: 24px;
      }
      .album-card .album-title {
        font-size: 14px;
        font-weight: bold;
        color: #333;
        margin-bottom: 4px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .album-card .album-meta {
        font-size: 11px;
        color: #666;
        margin-bottom: 8px;
      }
      .album-card .album-rating {
        margin-top: 8px;
        display: flex;
        justify-content: center;
        gap: 2px;
      }
      .album-card .star {
        font-size: 14px;
        margin-right: 0;
      }
      /* View Toggle Styles */
      .view-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
      }
      .view-toggle label {
        font-size: 12px;
        font-weight: bold;
        color: #333;
        white-space: nowrap;
      }
      .view-toggle-btn {
        padding: 6px 10px;
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
        min-width: 50px;
      }
      .view-toggle-btn:hover {
        background-color: #e6f3ff;
      }
      .view-toggle-btn.active {
        background-color: #007acc;
        color: white;
        border-color: #007acc;
      }
      /* Responsive Grid */
      @media (max-width: 768px) {
        .album-grid-container {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 15px;
        }
        .album-card .album-thumbnail-container {
          width: 100px;
          height: 100px;
        }
        .album-grid-item {
          padding: 12px;
        }
      }
      @media (max-width: 480px) {
        .album-grid-container {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 10px;
        }
        .album-card .album-thumbnail-container {
          width: 80px;
          height: 80px;
        }
        .album-grid-item {
          padding: 8px;
        }
      }
      /* Album Details Styles */
      .album-details-container {
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }
      .album-details-header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }
      .album-details-info {
        flex: 1;
      }
      .album-file-list {
        margin-bottom: 20px;
      }
      .album-files-grid {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #fafafa;
      }
      .album-file-item {
        border-bottom: 1px solid #eee;
      }
      .album-file-item:last-child {
        border-bottom: none;
      }
      .album-file-item.selected {
        background-color: #cce7ff !important;
        border-color: #007acc;
      }
      .album-file-preview {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 15px;
        background-color: #fafafa;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Media File Organizer</h1>
      <div class="controls">
        <button onclick="selectFolder()">„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû</button>
        <button onclick="refreshFiles()">Êõ¥Êñ∞</button>
      </div>
      <div class="main-content">
        <div class="file-list-container">
          <h3>„Éï„Ç°„Ç§„É´‰∏ÄË¶ß</h3>
          <div class="search-filters" id="searchFilters" style="display: none">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="„Éï„Ç°„Ç§„É´Âêç„Éª„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„Éª„Ç¢„É´„Éê„É†„ÅßÊ§úÁ¥¢..."
            />
            <div class="filter-buttons">
              <button class="filter-btn active" data-type="all">ÂÖ®„Å¶</button>
              <button class="filter-btn" data-type="image">üñºÔ∏è ÁîªÂÉè</button>
              <button class="filter-btn" data-type="video">üé¨ ÂãïÁîª</button>
              <button class="filter-btn" data-type="audio">üéµ Èü≥Â£∞</button>
              <button class="filter-btn" id="artistGroupBtn" data-group="artist">
                üé§ „Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂà•
              </button>
            </div>
            <div class="sort-rating-controls">
              <div class="sort-controls">
                <label for="sortSelect">‰∏¶„Å≥È†Ü:</label>
                <select id="sortSelect" class="sort-select">
                  <option value="name-asc">„Ç¢„É´„Éê„É†Âêç (A-Z)</option>
                  <option value="name-desc">„Ç¢„É´„Éê„É†Âêç (Z-A)</option>
                  <option value="artist-asc">„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç (A-Z)</option>
                  <option value="artist-desc">„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç (Z-A)</option>
                  <option value="rating-desc">„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞ (È´ò‚Üí‰Ωé)</option>
                  <option value="rating-asc">„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞ (‰Ωé‚ÜíÈ´ò)</option>
                  <option value="filecount-desc">„Éï„Ç°„Ç§„É´Êï∞ (Â§ö‚ÜíÂ∞ë)</option>
                  <option value="filecount-asc">„Éï„Ç°„Ç§„É´Êï∞ (Â∞ë‚ÜíÂ§ö)</option>
                </select>
              </div>
              <div class="rating-filter-controls">
                <label for="ratingFilter">„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞„Éï„Ç£„É´„Çø„Éº:</label>
                <select id="ratingFilter" class="rating-filter">
                  <option value="all">ÂÖ®„Å¶Ë°®Á§∫</option>
                  <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5Êòü)</option>
                  <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4Êòü‰ª•‰∏ä)</option>
                  <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3Êòü‰ª•‰∏ä)</option>
                  <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2Êòü‰ª•‰∏ä)</option>
                  <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1Êòü‰ª•‰∏ä)</option>
                  <option value="unrated">Êú™Ë©ï‰æ°„ÅÆ„Åø</option>
                </select>
              </div>
              <div class="view-toggle">
                <label for="viewToggle">Ë°®Á§∫:</label>
                <button class="view-toggle-btn active" data-view="list">„É™„Çπ„Éà</button>
                <button class="view-toggle-btn" data-view="grid">„Ç∞„É™„ÉÉ„Éâ</button>
              </div>
            </div>
            <div class="file-count" id="fileCount"></div>
          </div>
          <div class="file-list" id="fileList">
            <p>„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû„Åó„Å¶„É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫„Åó„Åæ„Åô</p>
          </div>
        </div>
        <div class="preview-container">
          <h3>„Éó„É¨„Éì„É•„Éº</h3>
          <div class="preview-content" id="previewContent">
            <div class="preview-placeholder">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫„Åó„Åæ„Åô</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require('electron');

      // Load utility modules
      const ratingUtils = require('./renderer/utils/rating');
      const sortingUtils = require('./renderer/utils/sorting');
      const searchUtils = require('./renderer/utils/search');
      const playlistUtils = require('./renderer/utils/playlist');
      const uiUtils = require('./renderer/utils/ui');
      const thumbnailUtils = require('./renderer/utils/thumbnail');

      // Make rating functions available globally for backward compatibility
      window.ratingUtils = ratingUtils;
      const { saveRating, loadRating, loadAllRatings, getAlbumRating } = ratingUtils;
      const { filterAlbumsByRating, sortAlbums } = sortingUtils;
      const { filterFilesBySearch, filterFilesByType, groupFilesByArtist, groupFilesByAlbum } =
        searchUtils;
      const { extractAudioFiles, createAlbumPlaylist } = playlistUtils;
      const { getFileIcon, formatFileSize, formatDate } = uiUtils;
      const { getAlbumThumbnailElement } = thumbnailUtils;

      // Error logging utility - logs errors to both browser console and server terminal
      async function errorLog(context, message, data = null) {
        const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
        const logMessage = `[${timestamp}] ERROR ${context}: ${message}`;

        // Browser console
        console.error(logMessage, data || '');

        // Server terminal via IPC
        try {
          await ipcRenderer.invoke('debug-log', context, message, data);
        } catch (error) {
          console.warn('Failed to send log to main process:', error);
        }
      }

      let currentFolder = null;
      let allFiles = [];
      let currentFilter = 'all';
      let currentSearch = '';
      let groupByArtist = false;
      let groupByAlbum = false;
      let currentSort = 'name-asc';
      let currentRatingFilter = 'all';
      let currentViewMode = 'list';
      let currentPlaylist = null;
      let currentAudioElement = null;

      async function selectFolder() {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.appendChild(document.createTextNode('„Éï„Ç©„É´„ÉÄ„ÇíË™≠„ÅøËæº„Åø‰∏≠...'));
        loadingDiv.appendChild(document.createElement('br'));
        const smallText = document.createElement('small');
        smallText.textContent = '„Çµ„Éñ„Éï„Ç©„É´„ÉÄ„ÇÇÂê´„ÇÅ„Å¶Ê§úÁ¥¢„Åó„Å¶„ÅÑ„Åæ„Åô';
        loadingDiv.appendChild(smallText);
        fileList.appendChild(loadingDiv);

        try {
          const result = await ipcRenderer.invoke('select-folder');
          if (result) {
            currentFolder = result;
            allFiles = result.files;
            setupFilters();
            displayFilteredFiles();
          } else {
            fileList.innerHTML = '';
            const message = document.createElement('p');
            message.textContent = '„Éï„Ç©„É´„ÉÄ„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü';
            fileList.appendChild(message);
          }
        } catch (error) {
          console.error('=== FOLDER SELECTION ERROR ===');
          console.error('Error message:', error.message);
          console.error('Error stack:', error.stack);
          console.error('Error type:', error.constructor.name);
          console.error('Application state:', {
            groupByArtist: groupByArtist,
            currentFilter: currentFilter,
            allFilesCount: allFiles?.length || 0,
            currentFolderPath: currentFolder?.folder || 'none'
          });
          console.error('================================');

          fileList.innerHTML = '';
          const message = document.createElement('p');
          message.textContent = `„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message || 'Unknown error'}`;
          fileList.appendChild(message);
        }
      }

      function displayFiles(data) {
        const fileList = document.getElementById('fileList');

        // Clear existing content
        fileList.innerHTML = '';

        if (!data || !data.files || data.files.length === 0) {
          const message = document.createElement('p');
          message.textContent = '„É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
          fileList.appendChild(message);
          return;
        }

        // Create folder info section
        const folderInfo = document.createElement('div');
        folderInfo.className = 'folder-info';

        const folderPath = document.createElement('div');
        const folderLabel = document.createElement('strong');
        folderLabel.textContent = 'ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç©„É´„ÉÄ:';
        folderPath.appendChild(folderLabel);
        folderPath.appendChild(document.createTextNode(' ' + data.folder));

        const fileCount = document.createElement('div');
        const countLabel = document.createElement('strong');
        countLabel.textContent = '„É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´Êï∞:';
        fileCount.appendChild(countLabel);
        fileCount.appendChild(document.createTextNode(` ${data.files.length}‰ª∂`));

        folderInfo.appendChild(folderPath);
        folderInfo.appendChild(fileCount);
        fileList.appendChild(folderInfo);

        // Create file items
        data.files.forEach(file => {
          const icon = getFileIcon(file.type);
          const sizeStr = formatFileSize(file.size);
          const dateStr = new Date(file.modified).toLocaleDateString('ja-JP');

          // Create file item container
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.dataset.path = file.path;

          // Add click event listener
          fileItem.addEventListener('click', () => {
            previewFile(file.path, file.type, file.name, file.size);
          });

          // Create icon element
          const iconDiv = document.createElement('div');
          iconDiv.className = 'file-icon';
          iconDiv.textContent = icon;

          // Create details container
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'file-details';

          // Create file name element
          const fileName = document.createElement('div');
          fileName.className = 'file-name';
          fileName.textContent = file.name;

          // Create file meta element
          const fileMeta = document.createElement('div');
          fileMeta.className = 'file-meta';

          // Add folder path if file is in subdirectory
          const pathInfo = file.relativePath ? ` (${file.relativePath}/)` : '';
          fileMeta.textContent = `${file.type} ‚Ä¢ ${sizeStr} ‚Ä¢ ${dateStr}${pathInfo}`;

          // Assemble the structure
          detailsDiv.appendChild(fileName);
          detailsDiv.appendChild(fileMeta);
          fileItem.appendChild(iconDiv);
          fileItem.appendChild(detailsDiv);
          fileList.appendChild(fileItem);
        });
      }

      function refreshFiles() {
        if (currentFolder) {
          displayFilteredFiles();
        } else {
          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';
          const message = document.createElement('p');
          message.textContent = '„Åæ„Åö„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          fileList.appendChild(message);
        }
      }

      function setupFilters() {
        const searchFilters = document.getElementById('searchFilters');
        const searchInput = document.getElementById('searchInput');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const sortSelect = document.getElementById('sortSelect');
        const ratingFilter = document.getElementById('ratingFilter');
        const viewToggleButtons = document.querySelectorAll('.view-toggle-btn');

        // Show filters
        searchFilters.style.display = 'block';

        // Setup search input
        searchInput.addEventListener('input', e => {
          currentSearch = e.target.value.toLowerCase();
          displayFilteredFiles();
        });

        // Setup sort select
        sortSelect.addEventListener('change', e => {
          currentSort = e.target.value;
          displayFilteredFiles();
        });

        // Setup rating filter
        ratingFilter.addEventListener('change', e => {
          currentRatingFilter = e.target.value;
          displayFilteredFiles();
        });

        // Setup filter buttons
        filterButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.dataset.group === 'artist') {
              // Toggle artist grouping
              groupByArtist = !groupByArtist;
              btn.classList.toggle('active');

              // Reset filters when grouping by artist
              if (groupByArtist) {
                filterButtons.forEach(b => {
                  if (b.dataset.type) b.classList.remove('active');
                });
                document.querySelector('[data-type="all"]').classList.add('active');
                currentFilter = 'all';
              }
            } else {
              // Regular filter buttons
              if (groupByArtist) {
                groupByArtist = false;
                document.getElementById('artistGroupBtn').classList.remove('active');
              }
              filterButtons.forEach(b => {
                if (b.dataset.type) b.classList.remove('active');
              });
              btn.classList.add('active');
              currentFilter = btn.dataset.type;
            }
            displayFilteredFiles();
          });
        });

        // Setup view toggle buttons
        viewToggleButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            // Update active state
            viewToggleButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update view mode
            currentViewMode = btn.dataset.view;

            // Disable grid view when artist grouping is active
            if (groupByArtist && currentViewMode === 'grid') {
              // Switch back to list view
              currentViewMode = 'list';
              document.querySelector('[data-view="list"]').classList.add('active');
              btn.classList.remove('active');
              return;
            }

            displayFilteredFiles();
          });
        });
      }

      function displayFilteredFiles() {
        if (!allFiles || allFiles.length === 0) {
          displayFiles({ folder: currentFolder?.folder || '', files: [] });
          return;
        }

        // Apply filters
        let filteredFiles = filterFilesByType(allFiles, currentFilter);
        filteredFiles = filterFilesBySearch(filteredFiles, currentSearch);

        // Update file count
        const fileCount = document.getElementById('fileCount');
        fileCount.textContent = `${filteredFiles.length}‰ª∂ / ${allFiles.length}‰ª∂`;

        // Display files (grouped or normal)
        if (groupByArtist) {
          displayArtistGroups(filteredFiles);
        } else if (currentViewMode === 'grid') {
          displayAlbumsGrid(filteredFiles);
        } else {
          displayAlbumGroups(filteredFiles);
        }
      }

      function displayAlbumsGrid(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        // Group files by album (simple structure)
        let albumGroups = groupFilesByAlbum(files);

        // Apply rating filter (for simple album structure)
        albumGroups = filterAlbumsByRatingSimple(albumGroups, currentRatingFilter);

        // Apply sorting (for simple album structure)
        albumGroups = sortAlbumsSimple(albumGroups, currentSort);

        // Create grid container
        const gridContainer = document.createElement('div');
        gridContainer.className = 'album-grid-container';

        // Create album cards
        Object.keys(albumGroups).forEach(albumName => {
          const albumFiles = albumGroups[albumName];

          // Ensure albumFiles is an array
          if (!Array.isArray(albumFiles)) {
            errorLog('GridView', 'albumFiles is not an array', {
              albumName: albumName,
              albumFilesType: typeof albumFiles,
              albumFiles: albumFiles
            });
            return;
          }

          // Create grid item
          const gridItem = document.createElement('div');
          gridItem.className = 'album-grid-item';

          // Create album card
          const albumCard = document.createElement('div');
          albumCard.className = 'album-card';

          // Add album thumbnail
          const thumbnailElement = getAlbumThumbnailElement(albumFiles, albumName);
          albumCard.appendChild(thumbnailElement);

          // Create album title
          const albumTitle = document.createElement('div');
          albumTitle.className = 'album-title';
          albumTitle.textContent = albumName;
          albumCard.appendChild(albumTitle);

          // Create album metadata
          const albumMeta = document.createElement('div');
          albumMeta.className = 'album-meta';
          const audioCount = albumFiles.filter(f => f.type === 'audio').length;
          const imageCount = albumFiles.filter(f => f.type === 'image').length;
          const videoCount = albumFiles.filter(f => f.type === 'video').length;
          let metaText = `${albumFiles.length}‰ª∂`;
          if (audioCount > 0) metaText += ` üéµ${audioCount}`;
          if (imageCount > 0) metaText += ` üñºÔ∏è${imageCount}`;
          if (videoCount > 0) metaText += ` üé¨${videoCount}`;
          albumMeta.textContent = metaText;
          albumCard.appendChild(albumMeta);

          // Add star rating UI
          const albumRating = document.createElement('div');
          albumRating.className = 'album-rating';

          // Get artist name from the first file in the album for rating key
          const firstFile = albumFiles[0];
          const artistName = firstFile.artist || '„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„Å™„Åó';
          const albumKey = `${artistName}/${albumName}`;

          for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.className = 'star';
            star.textContent = '‚òÖ';
            star.dataset.rating = i;
            star.dataset.albumKey = albumKey;

            // Add click handler for star rating
            star.addEventListener('click', async e => {
              e.stopPropagation();
              const rating = parseInt(e.target.dataset.rating);
              const albumKey = e.target.dataset.albumKey;

              // Update visual state
              const stars = albumRating.querySelectorAll('.star');
              stars.forEach((s, index) => {
                if (index < rating) {
                  s.classList.add('active');
                } else {
                  s.classList.remove('active');
                }
              });

              // Save rating
              saveRating(albumKey, rating);
              console.log(`Rating saved: ${albumKey} = ${rating} stars`);
            });

            albumRating.appendChild(star);
          }

          albumCard.appendChild(albumRating);

          // Load and display saved rating
          const savedRating = loadRating(albumKey);
          if (savedRating > 0) {
            const stars = albumRating.querySelectorAll('.star');
            stars.forEach((s, index) => {
              if (index < savedRating) {
                s.classList.add('active');
              }
            });
          }

          // Add click handler to show album details in preview
          gridItem.addEventListener('click', () => {
            // Show album details with file list
            showAlbumDetails(albumFiles, albumName);
          });

          gridItem.appendChild(albumCard);
          gridContainer.appendChild(gridItem);
        });

        fileList.appendChild(gridContainer);
      }

      // Simple rating filter for album-only structure (not nested by artist)
      function filterAlbumsByRatingSimple(albumGroups, ratingFilter) {
        if (ratingFilter === 'all') {
          return albumGroups;
        }

        const filtered = {};

        Object.keys(albumGroups).forEach(albumName => {
          const albumFiles = albumGroups[albumName];
          if (!Array.isArray(albumFiles) || albumFiles.length === 0) return;

          // Get artist name from first file for rating key
          const firstFile = albumFiles[0];
          const artistName = firstFile.artist || '„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„Å™„Åó';
          const albumKey = `${artistName}/${albumName}`;
          const rating = loadRating(albumKey);

          let includeAlbum = false;
          if (ratingFilter === 'unrated') {
            includeAlbum = rating === 0;
          } else {
            const minRating = parseInt(ratingFilter);
            if (ratingFilter === '5') {
              includeAlbum = rating === 5;
            } else {
              includeAlbum = rating >= minRating;
            }
          }

          if (includeAlbum) {
            filtered[albumName] = albumFiles;
          }
        });

        return filtered;
      }

      // Simple sorting for album-only structure (not nested by artist)
      function sortAlbumsSimple(albumGroups, sortBy) {
        const albumEntries = Object.entries(albumGroups);

        albumEntries.sort(([albumNameA, albumFilesA], [albumNameB, albumFilesB]) => {
          switch (sortBy) {
            case 'name-asc':
              return albumNameA.localeCompare(albumNameB);
            case 'name-desc':
              return albumNameB.localeCompare(albumNameA);
            case 'rating-desc':
            case 'rating-asc': {
              // Get ratings for comparison
              const firstFileA = albumFilesA[0];
              const firstFileB = albumFilesB[0];
              const artistA = firstFileA?.artist || '„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„Å™„Åó';
              const artistB = firstFileB?.artist || '„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„Å™„Åó';
              const ratingA = loadRating(`${artistA}/${albumNameA}`);
              const ratingB = loadRating(`${artistB}/${albumNameB}`);

              if (sortBy === 'rating-desc') {
                return ratingB - ratingA || albumNameA.localeCompare(albumNameB);
              } else {
                return ratingA - ratingB || albumNameA.localeCompare(albumNameB);
              }
            }
            case 'filecount-desc':
              return (
                albumFilesB.length - albumFilesA.length || albumNameA.localeCompare(albumNameB)
              );
            case 'filecount-asc':
              return (
                albumFilesA.length - albumFilesB.length || albumNameA.localeCompare(albumNameB)
              );
            default:
              return albumNameA.localeCompare(albumNameB);
          }
        });

        return Object.fromEntries(albumEntries);
      }

      // Show file preview in the preview panel
      async function showPreview(file) {
        if (!file) return;

        const previewContent = document.getElementById('previewContent');
        const fileName = file.name;
        const filePath = file.path;
        const fileType = file.type;
        const fileSize = file.size;
        const sizeStr = formatFileSize(fileSize);

        // Show loading state
        previewContent.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        const loadingText = document.createElement('p');
        loadingText.textContent = '„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...';
        loadingDiv.appendChild(loadingText);
        previewContent.appendChild(loadingDiv);

        try {
          const dataUrl = await ipcRenderer.invoke('get-file-url', filePath);

          if (!dataUrl) {
            throw new Error('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }

          // Create preview content container
          previewContent.innerHTML = '';
          const previewDiv = document.createElement('div');
          previewDiv.className = 'preview-content';

          // Create media element
          let mediaEl;
          switch (fileType) {
            case 'image':
              mediaEl = document.createElement('img');
              mediaEl.src = dataUrl;
              mediaEl.className = 'preview-image';
              mediaEl.alt = fileName;
              break;
            case 'video':
              mediaEl = document.createElement('video');
              mediaEl.src = dataUrl;
              mediaEl.className = 'preview-video';
              mediaEl.controls = true;
              break;
            case 'audio':
              mediaEl = document.createElement('audio');
              mediaEl.src = dataUrl;
              mediaEl.className = 'preview-audio';
              mediaEl.controls = true;
              break;
            default:
              throw new Error('„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
          }

          // Add file information
          const infoDiv = document.createElement('div');
          infoDiv.className = 'preview-info';

          const fileNameInfo = document.createElement('p');
          fileNameInfo.innerHTML = `<strong>„Éï„Ç°„Ç§„É´Âêç:</strong> ${fileName}`;

          const fileSizeInfo = document.createElement('p');
          fileSizeInfo.innerHTML = `<strong>„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫:</strong> ${sizeStr}`;

          const fileTypeInfo = document.createElement('p');
          fileTypeInfo.innerHTML = `<strong>„Éï„Ç°„Ç§„É´Á®ÆÂà•:</strong> ${fileType}`;

          const filePathInfo = document.createElement('p');
          filePathInfo.innerHTML = `<strong>„Éë„Çπ:</strong> ${filePath}`;

          infoDiv.appendChild(fileNameInfo);
          infoDiv.appendChild(fileSizeInfo);
          infoDiv.appendChild(fileTypeInfo);
          infoDiv.appendChild(filePathInfo);

          previewDiv.appendChild(mediaEl);
          previewDiv.appendChild(infoDiv);
          previewContent.appendChild(previewDiv);
        } catch (error) {
          console.error('=== FILE PREVIEW ERROR ===');
          console.error('Error message:', error.message);
          console.error('File details:', {
            fileName: fileName,
            filePath: filePath,
            fileType: fileType,
            fileSize: fileSize
          });
          console.error('==========================');

          previewContent.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'preview-placeholder';

          const errorIcon = document.createElement('div');
          errorIcon.style.fontSize = '48px';
          errorIcon.style.marginBottom = '20px';
          errorIcon.textContent = '‚ùå';

          const errorText = document.createElement('p');
          errorText.textContent = '„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';

          const errorDetails = document.createElement('small');
          errorDetails.style.color = '#666';
          errorDetails.textContent = error.message;

          errorDiv.appendChild(errorIcon);
          errorDiv.appendChild(errorText);
          errorDiv.appendChild(errorDetails);
          previewContent.appendChild(errorDiv);
        }
      }

      // Show album details in the preview area with file list
      function showAlbumDetails(albumFiles, albumName) {
        if (!albumFiles || albumFiles.length === 0) return;

        // Initialize playlist for this album
        currentPlaylist = createAlbumPlaylist(albumFiles);

        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = '';

        // Create main container
        const detailsContainer = document.createElement('div');
        detailsContainer.className = 'album-details-container';

        // Album header section
        const albumHeader = document.createElement('div');
        albumHeader.className = 'album-details-header';

        // Album thumbnail
        const thumbnailElement = getAlbumThumbnailElement(albumFiles, albumName);
        thumbnailElement.style.marginRight = '15px';

        // Album info
        const albumInfo = document.createElement('div');
        albumInfo.className = 'album-details-info';

        const albumTitle = document.createElement('h3');
        albumTitle.textContent = albumName;
        albumTitle.style.margin = '0 0 8px 0';

        const albumMeta = document.createElement('div');
        const audioCount = albumFiles.filter(f => f.type === 'audio').length;
        const imageCount = albumFiles.filter(f => f.type === 'image').length;
        const videoCount = albumFiles.filter(f => f.type === 'video').length;
        let metaText = `${albumFiles.length}‰ª∂`;
        if (audioCount > 0) metaText += ` üéµ${audioCount}`;
        if (imageCount > 0) metaText += ` üñºÔ∏è${imageCount}`;
        if (videoCount > 0) metaText += ` üé¨${videoCount}`;
        albumMeta.textContent = metaText;
        albumMeta.style.color = '#666';
        albumMeta.style.fontSize = '14px';

        // Album rating
        const albumRating = document.createElement('div');
        albumRating.className = 'album-rating';
        albumRating.style.marginTop = '8px';

        // Get artist name from first file for rating key
        const firstFile = albumFiles[0];
        const artistName = firstFile.artist || '„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„Å™„Åó';
        const albumKey = `${artistName}/${albumName}`;

        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.className = 'star';
          star.textContent = '‚òÖ';
          star.dataset.rating = i;
          star.dataset.albumKey = albumKey;

          star.addEventListener('click', async e => {
            e.stopPropagation();
            const rating = parseInt(e.target.dataset.rating);
            const albumKey = e.target.dataset.albumKey;

            // Update visual state
            const stars = albumRating.querySelectorAll('.star');
            stars.forEach((s, index) => {
              if (index < rating) {
                s.classList.add('active');
              } else {
                s.classList.remove('active');
              }
            });

            // Save rating
            saveRating(albumKey, rating);
          });

          albumRating.appendChild(star);
        }

        // Load and display saved rating
        const savedRating = loadRating(albumKey);
        if (savedRating > 0) {
          const stars = albumRating.querySelectorAll('.star');
          stars.forEach((s, index) => {
            if (index < savedRating) {
              s.classList.add('active');
            }
          });
        }

        albumInfo.appendChild(albumTitle);
        albumInfo.appendChild(albumMeta);
        albumInfo.appendChild(albumRating);

        albumHeader.appendChild(thumbnailElement);
        albumHeader.appendChild(albumInfo);

        // File list section
        const fileListSection = document.createElement('div');
        fileListSection.className = 'album-file-list';
        fileListSection.style.marginTop = '20px';
        fileListSection.style.borderTop = '1px solid #ddd';
        fileListSection.style.paddingTop = '15px';

        const fileListTitle = document.createElement('h4');
        fileListTitle.textContent = '„Éï„Ç°„Ç§„É´‰∏ÄË¶ß';
        fileListTitle.style.margin = '0 0 10px 0';
        fileListTitle.style.color = '#333';

        const fileList = document.createElement('div');
        fileList.className = 'album-files-grid';

        // Add files to list
        albumFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'album-file-item';
          fileItem.style.cssText = `
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 2px 0;
            border: 1px solid #eee;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
          `;

          fileItem.addEventListener('mouseenter', () => {
            fileItem.style.backgroundColor = '#f0f8ff';
          });
          fileItem.addEventListener('mouseleave', () => {
            if (!fileItem.classList.contains('selected')) {
              fileItem.style.backgroundColor = '';
            }
          });

          // File icon
          const icon = getFileIcon(file.type);
          const iconDiv = document.createElement('div');
          iconDiv.style.cssText = 'width: 20px; margin-right: 10px; text-align: center;';
          iconDiv.textContent = icon;

          // File name and details
          const fileDetails = document.createElement('div');
          fileDetails.style.flex = '1';

          const fileName = document.createElement('div');
          fileName.style.fontWeight = 'bold';
          fileName.style.color = '#333';
          fileName.textContent = file.name;

          const fileMeta = document.createElement('div');
          fileMeta.style.fontSize = '12px';
          fileMeta.style.color = '#666';
          fileMeta.textContent = `${file.type} ‚Ä¢ ${formatFileSize(file.size)}`;

          fileDetails.appendChild(fileName);
          fileDetails.appendChild(fileMeta);

          fileItem.appendChild(iconDiv);
          fileItem.appendChild(fileDetails);

          // Click handler to show preview
          fileItem.addEventListener('click', () => {
            // Remove selection from other items
            fileList.querySelectorAll('.album-file-item').forEach(item => {
              item.classList.remove('selected');
              item.style.backgroundColor = '';
            });

            // Select current item
            fileItem.classList.add('selected');
            fileItem.style.backgroundColor = '#cce7ff';

            // Update playlist current position if it's an audio file
            if (currentPlaylist && file.type === 'audio') {
              currentPlaylist.setCurrentByPath(file.path);
            }

            // Show preview below
            showFilePreviewInDetails(file);
          });

          fileList.appendChild(fileItem);

          // Auto-select first file
          if (index === 0) {
            fileItem.click();
          }
        });

        fileListSection.appendChild(fileListTitle);
        fileListSection.appendChild(fileList);

        // Preview section (will be populated by file selection)
        const previewSection = document.createElement('div');
        previewSection.className = 'album-file-preview';
        previewSection.id = 'albumFilePreview';
        previewSection.style.marginTop = '20px';
        previewSection.style.borderTop = '1px solid #ddd';
        previewSection.style.paddingTop = '15px';

        detailsContainer.appendChild(albumHeader);
        detailsContainer.appendChild(fileListSection);
        detailsContainer.appendChild(previewSection);

        previewContent.appendChild(detailsContainer);
      }

      // Show individual file preview within album details
      async function showFilePreviewInDetails(file) {
        const previewSection = document.getElementById('albumFilePreview');
        if (!previewSection) return;

        const fileName = file.name;
        const filePath = file.path;
        const fileType = file.type;
        const fileSize = file.size;
        const sizeStr = formatFileSize(fileSize);

        // Show loading state
        previewSection.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.textContent = '„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...';
        loadingDiv.style.textAlign = 'center';
        loadingDiv.style.padding = '20px';
        loadingDiv.style.color = '#666';
        previewSection.appendChild(loadingDiv);

        try {
          const dataUrl = await ipcRenderer.invoke('get-file-url', filePath);

          if (!dataUrl) {
            throw new Error('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }

          // Create preview content
          previewSection.innerHTML = '';

          const previewTitle = document.createElement('h4');
          previewTitle.textContent = '„Éó„É¨„Éì„É•„Éº';
          previewTitle.style.margin = '0 0 10px 0';
          previewTitle.style.color = '#333';

          const previewContent = document.createElement('div');
          previewContent.style.textAlign = 'center';

          // Create media element
          let mediaEl;
          switch (fileType) {
            case 'image':
              mediaEl = document.createElement('img');
              mediaEl.src = dataUrl;
              mediaEl.style.maxWidth = '100%';
              mediaEl.style.maxHeight = '300px';
              mediaEl.style.borderRadius = '4px';
              mediaEl.alt = fileName;
              break;
            case 'video':
              mediaEl = document.createElement('video');
              mediaEl.src = dataUrl;
              mediaEl.style.maxWidth = '100%';
              mediaEl.style.maxHeight = '300px';
              mediaEl.controls = true;
              break;
            case 'audio':
              mediaEl = document.createElement('audio');
              mediaEl.src = dataUrl;
              mediaEl.style.width = '100%';
              mediaEl.controls = true;

              // Store reference to current audio element
              currentAudioElement = mediaEl;

              // Add ended event listener for continuous playback
              mediaEl.addEventListener('ended', () => {
                if (currentPlaylist && currentPlaylist.hasNext()) {
                  const nextFile = currentPlaylist.next();
                  if (nextFile) {
                    // Auto-play next audio file
                    playAudioFile(nextFile);
                  }
                }
              });
              break;
            default:
              throw new Error('„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
          }

          // File info
          const fileInfo = document.createElement('div');
          fileInfo.style.marginTop = '15px';
          fileInfo.style.textAlign = 'left';
          fileInfo.style.fontSize = '14px';
          fileInfo.innerHTML = `
            <strong>„Éï„Ç°„Ç§„É´Âêç:</strong> ${fileName}<br>
            <strong>„Çµ„Ç§„Ç∫:</strong> ${sizeStr}<br>
            <strong>Á®ÆÂà•:</strong> ${fileType}<br>
            <strong>„Éë„Çπ:</strong> ${filePath}
          `;

          previewContent.appendChild(mediaEl);

          // Add navigation buttons for audio files
          if (fileType === 'audio' && currentPlaylist && currentPlaylist.getLength() > 1) {
            const navButtons = document.createElement('div');
            navButtons.style.marginTop = '10px';
            navButtons.style.textAlign = 'center';

            const prevButton = document.createElement('button');
            prevButton.textContent = '‚èÆ Ââç';
            prevButton.style.marginRight = '10px';
            prevButton.style.padding = '8px 16px';
            prevButton.style.border = '1px solid #ddd';
            prevButton.style.borderRadius = '4px';
            prevButton.style.backgroundColor = '#f8f9fa';
            prevButton.style.cursor = 'pointer';
            prevButton.disabled = !currentPlaylist.hasPrevious();

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Ê¨° ‚è≠';
            nextButton.style.padding = '8px 16px';
            nextButton.style.border = '1px solid #ddd';
            nextButton.style.borderRadius = '4px';
            nextButton.style.backgroundColor = '#f8f9fa';
            nextButton.style.cursor = 'pointer';
            nextButton.disabled = !currentPlaylist.hasNext();

            // Event handlers
            prevButton.addEventListener('click', () => {
              if (currentPlaylist.hasPrevious()) {
                const prevFile = currentPlaylist.previous();
                if (prevFile) {
                  playAudioFile(prevFile);
                }
              }
            });

            nextButton.addEventListener('click', () => {
              if (currentPlaylist.hasNext()) {
                const nextFile = currentPlaylist.next();
                if (nextFile) {
                  playAudioFile(nextFile);
                }
              }
            });

            navButtons.appendChild(prevButton);
            navButtons.appendChild(nextButton);
            previewContent.appendChild(navButtons);
          }

          previewContent.appendChild(fileInfo);

          previewSection.appendChild(previewTitle);
          previewSection.appendChild(previewContent);
        } catch (error) {
          previewSection.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.style.textAlign = 'center';
          errorDiv.style.padding = '20px';
          errorDiv.style.color = '#d63031';
          errorDiv.innerHTML = `
            <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
            <div>„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>
            <small style="color: #666;">${error.message}</small>
          `;
          previewSection.appendChild(errorDiv);
        }
      }

      // Play audio file and update UI for continuous playback
      async function playAudioFile(file) {
        if (!file || file.type !== 'audio') return;

        try {
          // Update file list selection
          const fileList = document.querySelector('.album-file-list');
          if (fileList) {
            // Remove previous selection
            fileList.querySelectorAll('.album-file-item').forEach(item => {
              item.classList.remove('selected');
              item.style.backgroundColor = '';
            });

            // Find and select the current file item
            const fileItems = fileList.querySelectorAll('.album-file-item');
            fileItems.forEach(item => {
              const fileDetails = item.querySelector('.file-details');
              if (fileDetails && fileDetails.textContent.includes(file.name)) {
                item.classList.add('selected');
                item.style.backgroundColor = '#cce7ff';
              }
            });
          }

          // Show preview for the new file
          await showFilePreviewInDetails(file);
        } catch (error) {
          console.error('Error playing audio file:', error);
        }
      }

      function displayAlbumGroups(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        // Group files by album
        const albumGroups = {};
        files.forEach(file => {
          const album = file.album || '„Ç¢„É´„Éê„É†Âêç„Å™„Åó';
          if (!albumGroups[album]) {
            albumGroups[album] = [];
          }
          albumGroups[album].push(file);
        });

        // Create album groups
        Object.keys(albumGroups)
          .sort()
          .forEach(albumName => {
            const albumFiles = albumGroups[albumName];
            const albumGroup = document.createElement('div');
            albumGroup.className = 'album-group';

            // Create album header
            const albumHeader = document.createElement('div');
            albumHeader.className = 'album-header';
            albumHeader.addEventListener('click', () => {
              const albumFilesDiv = albumGroup.querySelector('.album-files');
              const toggle = albumGroup.querySelector('.album-toggle');
              albumFilesDiv.classList.toggle('collapsed');
              toggle.textContent = albumFilesDiv.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
            });

            // Add album thumbnail
            const thumbnailElement = getAlbumThumbnailElement(albumFiles, albumName);

            const albumInfo = document.createElement('div');
            const albumTitle = document.createElement('div');
            albumTitle.className = 'album-title';
            albumTitle.textContent = albumName;

            const albumMeta = document.createElement('div');
            albumMeta.className = 'album-meta';
            const audioCount = albumFiles.filter(f => f.type === 'audio').length;
            const imageCount = albumFiles.filter(f => f.type === 'image').length;
            const videoCount = albumFiles.filter(f => f.type === 'video').length;
            let metaText = `${albumFiles.length}‰ª∂`;
            if (audioCount > 0) metaText += ` (üéµ${audioCount}`;
            if (imageCount > 0) metaText += ` üñºÔ∏è${imageCount}`;
            if (videoCount > 0) metaText += ` üé¨${videoCount}`;
            if (audioCount > 0 || imageCount > 0 || videoCount > 0) metaText += ')';
            albumMeta.textContent = metaText;

            albumInfo.appendChild(albumTitle);
            albumInfo.appendChild(albumMeta);

            // Add star rating UI
            const albumRating = document.createElement('div');
            albumRating.className = 'album-rating';

            // Get artist name from the first file in the album for rating key
            const firstFile = albumFiles[0];
            const artistName = firstFile.artist || '„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„Å™„Åó';
            const albumKey = `${artistName}/${albumName}`;

            for (let i = 1; i <= 5; i++) {
              const star = document.createElement('span');
              star.className = 'star';
              star.textContent = '‚òÖ';
              star.dataset.rating = i;
              star.dataset.albumKey = albumKey;

              // Add click handler for star rating
              star.addEventListener('click', async e => {
                e.stopPropagation();
                const rating = parseInt(e.target.dataset.rating);
                const albumKey = e.target.dataset.albumKey;

                // Update visual state
                const stars = albumRating.querySelectorAll('.star');
                stars.forEach((s, index) => {
                  if (index < rating) {
                    s.classList.add('active');
                  } else {
                    s.classList.remove('active');
                  }
                });

                // Save rating
                saveRating(albumKey, rating);
                console.log(`Rating saved: ${albumKey} = ${rating} stars`);
              });

              albumRating.appendChild(star);
            }

            albumInfo.appendChild(albumRating);

            // Load and display saved rating
            const savedRating = loadRating(albumKey);
            console.log(`Loading rating for album: ${albumKey} = ${savedRating} stars`);
            if (savedRating > 0) {
              const stars = albumRating.querySelectorAll('.star');
              stars.forEach((s, index) => {
                if (index < savedRating) {
                  s.classList.add('active');
                }
              });
            }

            const albumToggle = document.createElement('div');
            albumToggle.className = 'album-toggle';
            albumToggle.textContent = '‚ñº';

            albumHeader.appendChild(thumbnailElement);
            albumHeader.appendChild(albumInfo);
            albumHeader.appendChild(albumToggle);

            // Create album files container
            const albumFilesDiv = document.createElement('div');
            albumFilesDiv.className = 'album-files';

            // Add files to album
            albumFiles.forEach(file => {
              const fileItem = createFileItem(file);
              albumFilesDiv.appendChild(fileItem);
            });

            albumGroup.appendChild(albumHeader);
            albumGroup.appendChild(albumFilesDiv);
            fileList.appendChild(albumGroup);
          });
      }

      function displayArtistGroups(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        // Group files by artist, then by album
        let artistGroups = groupFilesByArtist(files);

        // Apply rating filter
        artistGroups = filterAlbumsByRating(artistGroups, currentRatingFilter);

        // Apply sorting
        artistGroups = sortAlbums(artistGroups, currentSort);

        // Create artist groups
        Object.keys(artistGroups).forEach(artistName => {
          const artistAlbums = artistGroups[artistName];
          const artistGroup = document.createElement('div');
          artistGroup.className = 'artist-group';

          // Create artist header
          const artistHeader = document.createElement('div');
          artistHeader.className = 'artist-header';
          artistHeader.addEventListener('click', () => {
            const artistAlbumsDiv = artistGroup.querySelector('.artist-albums');
            const toggle = artistGroup.querySelector('.album-toggle');
            artistAlbumsDiv.classList.toggle('collapsed');
            toggle.textContent = artistAlbumsDiv.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
          });

          const artistInfo = document.createElement('div');
          const artistTitle = document.createElement('div');
          artistTitle.className = 'artist-title';
          artistTitle.textContent = `üìÄ ${artistName}`;

          const artistMeta = document.createElement('div');
          artistMeta.className = 'artist-meta';
          const albumCount = Object.keys(artistAlbums).length;
          const totalFiles = Object.values(artistAlbums).flat().length;
          const audioCount = Object.values(artistAlbums)
            .flat()
            .filter(f => f.type === 'audio').length;
          const imageCount = Object.values(artistAlbums)
            .flat()
            .filter(f => f.type === 'image').length;
          const videoCount = Object.values(artistAlbums)
            .flat()
            .filter(f => f.type === 'video').length;

          let metaText = `${albumCount}„Ç¢„É´„Éê„É†, ${totalFiles}‰ª∂`;
          if (audioCount > 0) metaText += ` (üéµ${audioCount}`;
          if (imageCount > 0) metaText += ` üñºÔ∏è${imageCount}`;
          if (videoCount > 0) metaText += ` üé¨${videoCount}`;
          if (audioCount > 0 || imageCount > 0 || videoCount > 0) metaText += ')';
          artistMeta.textContent = metaText;

          artistInfo.appendChild(artistTitle);
          artistInfo.appendChild(artistMeta);

          const artistToggle = document.createElement('div');
          artistToggle.className = 'album-toggle';
          artistToggle.textContent = '‚ñº';

          artistHeader.appendChild(artistInfo);
          artistHeader.appendChild(artistToggle);

          // Create artist albums container
          const artistAlbumsDiv = document.createElement('div');
          artistAlbumsDiv.className = 'artist-albums';

          // Add albums to artist
          Object.keys(artistAlbums)
            .sort()
            .forEach(albumName => {
              const albumFiles = artistAlbums[albumName];
              const nestedAlbum = document.createElement('div');
              nestedAlbum.className = 'nested-album';

              // Create album header
              const albumHeader = document.createElement('div');
              albumHeader.className = 'album-header';
              albumHeader.addEventListener('click', () => {
                const albumFilesDiv = nestedAlbum.querySelector('.album-files');
                const toggle = nestedAlbum.querySelector('.album-toggle');
                albumFilesDiv.classList.toggle('collapsed');
                toggle.textContent = albumFilesDiv.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
              });

              // Add album thumbnail
              const albumThumbnailElement = getAlbumThumbnailElement(albumFiles, albumName);

              const albumInfo = document.createElement('div');
              const albumTitle = document.createElement('div');
              albumTitle.className = 'album-title';
              albumTitle.textContent = `üìÅ ${albumName}`;

              const albumMeta = document.createElement('div');
              albumMeta.className = 'album-meta';
              const albumAudioCount = albumFiles.filter(f => f.type === 'audio').length;
              const albumImageCount = albumFiles.filter(f => f.type === 'image').length;
              const albumVideoCount = albumFiles.filter(f => f.type === 'video').length;
              let albumMetaText = `${albumFiles.length}‰ª∂`;
              if (albumAudioCount > 0) albumMetaText += ` (üéµ${albumAudioCount}`;
              if (albumImageCount > 0) albumMetaText += ` üñºÔ∏è${albumImageCount}`;
              if (albumVideoCount > 0) albumMetaText += ` üé¨${albumVideoCount}`;
              if (albumAudioCount > 0 || albumImageCount > 0 || albumVideoCount > 0)
                albumMetaText += ')';
              albumMeta.textContent = albumMetaText;

              albumInfo.appendChild(albumTitle);
              albumInfo.appendChild(albumMeta);

              // Add star rating UI
              const albumRating = document.createElement('div');
              albumRating.className = 'album-rating';

              for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = 'star';
                star.textContent = '‚òÖ';
                star.dataset.rating = i;
                star.dataset.albumKey = `${artistName}/${albumName}`;

                // Add click handler for star rating
                star.addEventListener('click', async e => {
                  e.stopPropagation();
                  const rating = parseInt(e.target.dataset.rating);
                  const albumKey = e.target.dataset.albumKey;

                  // Update visual state
                  const stars = albumRating.querySelectorAll('.star');
                  stars.forEach((s, index) => {
                    if (index < rating) {
                      s.classList.add('active');
                    } else {
                      s.classList.remove('active');
                    }
                  });

                  // Save rating
                  saveRating(albumKey, rating);
                  console.log(`Rating saved: ${albumKey} = ${rating} stars`);
                });

                albumRating.appendChild(star);
              }

              albumInfo.appendChild(albumRating);

              // Load and display saved rating
              const albumKey = `${artistName}/${albumName}`;
              const savedRating = loadRating(albumKey);
              console.log(`Loading rating for album: ${albumKey} = ${savedRating} stars`);
              if (savedRating > 0) {
                const stars = albumRating.querySelectorAll('.star');
                stars.forEach((s, index) => {
                  if (index < savedRating) {
                    s.classList.add('active');
                  }
                });
              }

              const albumToggle = document.createElement('div');
              albumToggle.className = 'album-toggle';
              albumToggle.textContent = '‚ñ∂';

              albumHeader.appendChild(albumThumbnailElement);
              albumHeader.appendChild(albumInfo);
              albumHeader.appendChild(albumToggle);

              // Create album files container (collapsed by default)
              const albumFilesDiv = document.createElement('div');
              albumFilesDiv.className = 'album-files collapsed';

              // Add files to album
              albumFiles.forEach(file => {
                const fileItem = createFileItem(file);
                albumFilesDiv.appendChild(fileItem);
              });

              nestedAlbum.appendChild(albumHeader);
              nestedAlbum.appendChild(albumFilesDiv);
              artistAlbumsDiv.appendChild(nestedAlbum);
            });

          artistGroup.appendChild(artistHeader);
          artistGroup.appendChild(artistAlbumsDiv);
          fileList.appendChild(artistGroup);
        });
      }

      function createFileItem(file) {
        const icon = getFileIcon(file.type);
        const sizeStr = formatFileSize(file.size);
        const dateStr = new Date(file.modified).toLocaleDateString('ja-JP');

        // Create file item container
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.path = file.path;

        // Add click event listener
        fileItem.addEventListener('click', () => {
          previewFile(file.path, file.type, file.name, file.size);
        });

        // Create icon element
        const iconDiv = document.createElement('div');
        iconDiv.className = 'file-icon';
        iconDiv.textContent = icon;

        // Create details container
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'file-details';

        // Create file name element (show title if available)
        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.textContent = file.title || file.name;

        // Create file meta element
        const fileMeta = document.createElement('div');
        fileMeta.className = 'file-meta';

        // Add artist info for audio files
        let metaText = `${file.type} ‚Ä¢ ${sizeStr} ‚Ä¢ ${dateStr}`;
        if (file.artist && file.type === 'audio') {
          metaText = `${file.artist} ‚Ä¢ ${metaText}`;
        }
        if (file.relativePath) {
          metaText += ` (${file.relativePath}/)`;
        }
        fileMeta.textContent = metaText;

        // Assemble the structure
        detailsDiv.appendChild(fileName);
        detailsDiv.appendChild(fileMeta);
        fileItem.appendChild(iconDiv);
        fileItem.appendChild(detailsDiv);

        return fileItem;
      }

      async function previewFile(filePath, fileType, fileName, fileSize) {
        // Remove previous selection
        document.querySelectorAll('.file-item').forEach(item => {
          item.classList.remove('selected');
        });

        // Add selection to clicked item
        event.target.closest('.file-item').classList.add('selected');

        const previewContent = document.getElementById('previewContent');
        const sizeStr = formatFileSize(fileSize);

        // Show loading state
        previewContent.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        const loadingText = document.createElement('p');
        loadingText.textContent = '„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...';
        loadingDiv.appendChild(loadingText);
        previewContent.appendChild(loadingDiv);

        try {
          const dataUrl = await ipcRenderer.invoke('get-file-url', filePath);

          if (!dataUrl) {
            throw new Error('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }

          // Create preview content container
          previewContent.innerHTML = '';
          const previewDiv = document.createElement('div');
          previewDiv.className = 'preview-content';

          // Create media element
          let mediaEl;
          switch (fileType) {
            case 'image':
              mediaEl = document.createElement('img');
              mediaEl.src = dataUrl;
              mediaEl.className = 'preview-image';
              mediaEl.alt = fileName;
              mediaEl.style.opacity = '0';
              mediaEl.style.transition = 'opacity 0.3s';
              mediaEl.onload = () => (mediaEl.style.opacity = '1');
              break;
            case 'video':
              mediaEl = document.createElement('video');
              mediaEl.className = 'preview-video';
              mediaEl.controls = true;
              mediaEl.preload = 'metadata';
              const videoSource = document.createElement('source');
              videoSource.src = dataUrl;
              mediaEl.appendChild(videoSource);
              const videoFallback = document.createElement('p');
              videoFallback.textContent = '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÂãïÁîª„ÅÆÂÜçÁîü„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
              mediaEl.appendChild(videoFallback);
              break;
            case 'audio':
              const audioContainer = document.createElement('div');
              audioContainer.style.textAlign = 'center';
              audioContainer.style.margin = '40px 0';
              const audioIcon = document.createElement('div');
              audioIcon.style.fontSize = '48px';
              audioIcon.style.marginBottom = '20px';
              audioIcon.textContent = 'üéµ';
              const audioEl = document.createElement('audio');
              audioEl.className = 'preview-audio';
              audioEl.controls = true;
              audioEl.preload = 'metadata';
              const audioSource = document.createElement('source');
              audioSource.src = dataUrl;
              audioEl.appendChild(audioSource);
              const audioFallback = document.createElement('p');
              audioFallback.textContent = '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞„ÅÆÂÜçÁîü„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
              audioEl.appendChild(audioFallback);
              audioContainer.appendChild(audioIcon);
              audioContainer.appendChild(audioEl);
              mediaEl = audioContainer;
              break;
            default:
              const placeholder = document.createElement('div');
              placeholder.className = 'preview-placeholder';
              const placeholderIcon = document.createElement('div');
              placeholderIcon.style.fontSize = '48px';
              placeholderIcon.style.marginBottom = '20px';
              placeholderIcon.textContent = 'üìÑ';
              const placeholderText = document.createElement('p');
              placeholderText.textContent = '„Åì„ÅÆ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÅØ„Éó„É¨„Éì„É•„Éº„Åß„Åç„Åæ„Åõ„Çì';
              placeholder.appendChild(placeholderIcon);
              placeholder.appendChild(placeholderText);
              mediaEl = placeholder;
          }

          // Create info section
          const infoDiv = document.createElement('div');
          infoDiv.className = 'preview-info';

          const fileNameInfo = document.createElement('div');
          const fileNameLabel = document.createElement('strong');
          fileNameLabel.textContent = '„Éï„Ç°„Ç§„É´Âêç:';
          fileNameInfo.appendChild(fileNameLabel);
          fileNameInfo.appendChild(document.createTextNode(' ' + fileName));

          const fileSizeInfo = document.createElement('div');
          const fileSizeLabel = document.createElement('strong');
          fileSizeLabel.textContent = '„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫:';
          fileSizeInfo.appendChild(fileSizeLabel);
          fileSizeInfo.appendChild(document.createTextNode(' ' + sizeStr));

          const fileTypeInfo = document.createElement('div');
          const fileTypeLabel = document.createElement('strong');
          fileTypeLabel.textContent = '„Éï„Ç°„Ç§„É´ÂΩ¢Âºè:';
          fileTypeInfo.appendChild(fileTypeLabel);
          fileTypeInfo.appendChild(document.createTextNode(' ' + fileType));

          const filePathInfo = document.createElement('div');
          const filePathLabel = document.createElement('strong');
          filePathLabel.textContent = '„Éë„Çπ:';
          filePathInfo.appendChild(filePathLabel);
          filePathInfo.appendChild(document.createTextNode(' ' + filePath));

          infoDiv.appendChild(fileNameInfo);
          infoDiv.appendChild(fileSizeInfo);
          infoDiv.appendChild(fileTypeInfo);
          infoDiv.appendChild(filePathInfo);

          previewDiv.appendChild(mediaEl);
          previewDiv.appendChild(infoDiv);
          previewContent.appendChild(previewDiv);
        } catch (error) {
          console.error('=== FILE PREVIEW ERROR ===');
          console.error('Error message:', error.message);
          console.error('Error stack:', error.stack);
          console.error('File details:', {
            fileName: fileName,
            filePath: filePath,
            fileType: fileType,
            fileSize: fileSize
          });
          console.error('==========================');
          previewContent.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'preview-placeholder';

          const errorIcon = document.createElement('div');
          errorIcon.style.fontSize = '48px';
          errorIcon.style.marginBottom = '20px';
          errorIcon.textContent = '‚ùå';

          const errorText = document.createElement('p');
          errorText.textContent = '„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';

          const errorDetails = document.createElement('p');
          errorDetails.style.fontSize = '0.8em';
          errorDetails.style.color = '#666';
          errorDetails.textContent = error.message;

          errorDiv.appendChild(errorIcon);
          errorDiv.appendChild(errorText);
          errorDiv.appendChild(errorDetails);
          previewContent.appendChild(errorDiv);
        }
      }

      // Global error handlers for better debugging
      window.addEventListener('error', event => {
        console.error('=== GLOBAL JAVASCRIPT ERROR ===');
        console.error('Error message:', event.message);
        console.error('Source file:', event.filename);
        console.error('Line number:', event.lineno);
        console.error('Column number:', event.colno);
        console.error('Error object:', event.error);
        console.error('==============================');
      });

      window.addEventListener('unhandledrejection', event => {
        console.error('=== UNHANDLED PROMISE REJECTION ===');
        console.error('Reason:', event.reason);
        console.error('Promise:', event.promise);
        console.error('Stack:', event.reason?.stack);
        console.error('===================================');
      });
    </script>
  </body>
</html>
